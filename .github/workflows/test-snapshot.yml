name: Test Snapshot (Scoring & Export)

on:
  workflow_dispatch:  # manueller Start √ºber GitHub Actions

jobs:
  test-snapshot:
    runs-on: ubuntu-latest

    env:
      ENABLE_PIT_CATEGORIES: "1"
      ENABLE_PIT_MEXC: "1"
      ENABLE_PIT_ALIAS: "1"
      ENABLE_PIT_SCORING: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest openpyxl pandas xlsxwriter

      - name: Run offline mock snapshot tests
        run: |
          echo "üîç Running offline snapshot pipeline tests (no API calls)"
          pytest -v tests/test_mock_snapshot.py --maxfail=1 --disable-warnings
          echo "‚úÖ Offline snapshot pipeline tests passed successfully"

      - name: Run scoring + export unit tests
        run: |
          echo "üß™ Running scoring & export tests..."
          pytest -q --disable-warnings || { echo "‚ùå Tests failed"; exit 1; }

      - name: Run snapshot in test mode (no commit, no upload)
        run: |
          echo "üöÄ Running test snapshot (scoring enabled)..."
          python -m colabtool.run_snapshot_mode || { echo "‚ùå Snapshot run failed"; exit 1; }

      - name: Verify Excel output presence
        run: |
          echo "üîç Checking if Excel snapshot was generated..."
          find snapshots -type f -name '*fullsnapshot.xlsx' || echo "‚ö†Ô∏è No Excel found"

      - name: Upload test snapshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-snapshot-results
          path: snapshots/
